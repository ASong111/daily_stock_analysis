# 市场环境过滤功能

## 功能概述

市场环境过滤器会在分析个股前，先判断大盘趋势状态，并根据市场环境动态调整个股买入门槛。

**核心理念：**
- **强市降低门槛**：牛市中适当放宽标准，避免错过机会
- **弱市提高门槛**：熊市中严格筛选，只做最优质标的

---

## 工作原理

### 1. 市场环境判断

系统会分析以下数据来判断市场环境：

#### 大盘趋势（基于上证指数）
- MA5、MA10、MA20 均线排列
- 均线间距变化（判断趋势强度）
- 指数涨跌幅

#### 市场情绪
- **涨跌比**：上涨家数 / 下跌家数
- **涨停数**：反映市场热度
- **成交额**：反映市场活跃度

### 2. 市场评分（0-100分）

| 维度 | 权重 | 说明 |
|-----|------|------|
| 趋势状态 | 40分 | 强势多头40分，多头35分，震荡20分，空头0-5分 |
| 涨跌比 | 30分 | ≥3.0得30分，≥2.0得25分，<0.5得0分 |
| 涨停数 | 15分 | ≥100得15分，≥50得12分，<10得3分 |
| 成交额 | 15分 | ≥1万亿得15分，≥6千亿得10分，<6千亿得5分 |

### 3. 动态调整策略

根据市场评分，系统会自动调整：

| 市场评分 | 个股评分调整 | 乖离率阈值 | 仓位建议 |
|---------|------------|-----------|---------|
| ≥75分（强势牛市） | +15分 | 7%（放宽） | 70-90% |
| 60-75分（牛市） | +10分 | 6%（放宽） | 60-80% |
| 50-60分（震荡） | 0分 | 5%（标准） | 40-60% |
| 40-50分（弱势熊市） | -10分 | 4%（收紧） | 20-40% |
| <40分（熊市） | -15分 | 3%（收紧） | 0-20% |

---

## 使用示例

### 场景1：强势牛市

```
市场环境：
- 上证指数：MA5 > MA10 > MA20（多头排列）
- 涨跌比：2.5（上涨3000家，下跌1200家）
- 涨停数：80家
- 成交额：9500亿
- 市场评分：72分（牛市）

调整策略：
- 个股评分调整：+10分
- 乖离率阈值：5% → 6%
- 仓位建议：60-80%
- 操作建议：市场向好，可积极参与，优选多头排列个股

个股示例：
- 原始评分：60分
- 调整后评分：70分 ✅ 通过（买入门槛60分）
- 可以买入
```

### 场景2：弱势熊市

```
市场环境：
- 上证指数：MA5 < MA10 < MA20（空头排列）
- 涨跌比：0.6（上涨1500家，下跌2500家）
- 涨停数：15家
- 成交额：5800亿
- 市场评分：42分（弱势熊市）

调整策略：
- 个股评分调整：-10分
- 乖离率阈值：5% → 4%
- 仓位建议：20-40%
- 操作建议：市场偏弱，提高买入标准，优选超跌反弹

个股示例：
- 原始评分：60分
- 调整后评分：50分 ❌ 未通过（买入门槛60分）
- 不建议买入
```

---

## 代码集成

### 核心文件

1. **src/market_filter.py** - 市场环境过滤器
   - `MarketFilter` 类：市场环境分析
   - `MarketEnvironment` 数据类：市场环境数据
   - `MarketTrend` 枚举：市场趋势状态

2. **src/core/pipeline.py** - 分析流水线（已集成）
   - `get_market_environment()` 方法：获取市场环境
   - `analyze_stock()` 方法：应用市场过滤

### 使用方法

```python
from src.market_filter import MarketFilter
from data_provider import DataFetcherManager

# 1. 初始化
market_filter = MarketFilter()
fetcher_manager = DataFetcherManager()

# 2. 获取上证指数数据
sh_index_df, _ = fetcher_manager.get_daily_data('sh000001', days=30)

# 3. 获取市场统计数据
market_stats = {
    'up_count': 3000,
    'down_count': 1200,
    'limit_up_count': 80,
    'limit_down_count': 5,
    'total_amount': 9500.0,  # 亿元
}

# 4. 分析市场环境
env = market_filter.analyze_market_environment(sh_index_df, market_stats)

# 5. 应用个股过滤
stock_score = 65
result = market_filter.apply_market_filter(stock_score, env)

print(f"原始评分: {result['original_score']}")
print(f"调整后评分: {result['adjusted_score']}")
print(f"是否通过: {result['passed']}")
```

---

## 测试

运行测试脚本：

```bash
python test_market_filter.py
```

测试内容：
1. 获取上证指数数据
2. 获取市场统计数据
3. 分析市场环境
4. 测试不同评分的个股过滤结果

---

## 配置

市场过滤器使用默认参数，无需额外配置。

如需调整阈值，可修改 `src/market_filter.py` 中的常量：

```python
class MarketFilter:
    # 成交额阈值（亿元）
    AMOUNT_THRESHOLD_HIGH = 10000    # 高成交额阈值
    AMOUNT_THRESHOLD_LOW = 6000      # 低成交额阈值

    # 涨跌比阈值
    UP_DOWN_RATIO_BULL = 2.0         # 牛市涨跌比阈值
    UP_DOWN_RATIO_BEAR = 0.5         # 熊市涨跌比阈值
```

---

## 注意事项

1. **数据依赖**
   - 需要能够获取上证指数历史数据
   - 需要能够获取全市场涨跌统计数据
   - 数据获取失败时，系统会使用默认标准（不调整）

2. **性能优化**
   - 市场环境分析结果会被缓存
   - 同一批次分析的所有个股共享市场环境
   - 避免重复分析大盘数据

3. **适用场景**
   - 适合中短期交易（1-2周）
   - 适合趋势明显的市场
   - 不适合超短线交易

---

## 相关文档

- [交易策略详解](trading-strategy.md) - 完整的交易策略说明
- [完整配置指南](full-guide.md) - 系统配置说明
- [项目 README](../README.md) - 项目概述

---

**最后更新：** 2026-01-26
