# 🏗️ 系统架构图

## 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                          用户接口层 (Interface Layer)                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────┐ │
│  │  命令行CLI    │  │   Web API    │  │  钉钉机器人   │  │  飞书   │ │
│  │  main.py     │  │  web/server  │  │  bot/dingtalk│  │  机器人  │ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └─────────┘ │
│                                                                       │
└───────────────────────────────┬───────────────────────────────────┘
                                │
                                ↓
┌─────────────────────────────────────────────────────────────────────┐
│                       业务逻辑层 (Business Layer)                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │
│  │  股票分析服务      │  │  智能选股服务      │  │  市场过滤服务      │  │
│  │  analyzer_service│  │  select_stocks   │  │  market_filter   │  │
│  │                  │  │                  │  │                  │  │
│  │  • 技术分析       │  │  • 板块识别       │  │  • 大盘趋势       │  │
│  │  • AI分析        │  │  • 成长股筛选     │  │  • 风险控制       │  │
│  │  • 新闻搜索       │  │  • 龙头推荐       │  │  • 市场环境       │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘  │
│                                                                       │
└───────────────────────────────┬───────────────────────────────────┘
                                │
                                ↓
┌─────────────────────────────────────────────────────────────────────┐
│                       核心服务层 (Core Services)                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐  │
│  │  技术分析引擎      │  │  AI分析引擎       │  │  搜索服务引擎      │  │
│  │  stock_analyzer  │  │  analyzer        │  │  search_service  │  │
│  │                  │  │                  │  │                  │  │
│  │  • 均线计算       │  │  • Gemini        │  │  • Bocha         │  │
│  │  • 指标计算       │  │  • Claude        │  │  • Tavily        │  │
│  │  • 趋势判断       │  │  • OpenAI        │  │  • SerpAPI       │  │
│  │  • 信号生成       │  │  • Prompt工程    │  │  • 多维搜索       │  │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘  │
│                                                                       │
└───────────────────────────────┬───────────────────────────────────┘
                                │
                                ↓
┌─────────────────────────────────────────────────────────────────────┐
│                       数据访问层 (Data Access Layer)                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌──────────────────────────────────────────────────────────────┐   │
│  │              数据管理器 (DataFetcherManager)                    │   │
│  │                                                                │   │
│  │  • 多源管理    • 故障转移    • 优先级控制    • 数据缓存        │   │
│  └──────────────────────────────────────────────────────────────┘   │
│                                                                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────┐ │
│  │ Tushare  │  │ AKShare  │  │ EFinance │  │ Baostock │  │YFinan│ │
│  │  数据源   │  │  数据源   │  │  数据源   │  │  数据源   │  │ce源 │ │
│  │          │  │          │  │          │  │          │  │      │ │
│  │ Priority │  │ Priority │  │ Priority │  │ Priority │  │Priori│ │
│  │    0     │  │    1     │  │    0     │  │    3     │  │ty 4  │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────┘ │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 数据流图

### 1. 股票分析流程

```
用户输入股票代码 (600519)
         │
         ↓
┌────────────────────┐
│  1. 数据获取        │
│  DataFetcher       │
│  • 获取60日K线     │
│  • 多源自动切换     │
└────────────────────┘
         │
         ↓
┌────────────────────┐
│  2. 技术分析        │
│  StockAnalyzer     │
│  • 计算均线         │
│  • 计算MACD/KDJ    │
│  • 判断趋势         │
│  • 生成评分         │
└────────────────────┘
         │
         ↓
┌────────────────────┐
│  3. 新闻搜索 (可选) │
│  SearchService     │
│  • 最新消息         │
│  • 风险排查         │
│  • 业绩预期         │
└────────────────────┘
         │
         ↓
┌────────────────────┐
│  4. AI分析          │
│  AIAnalyzer        │
│  • 构建上下文       │
│  • 调用AI模型       │
│  • 生成建议         │
└────────────────────┘
         │
         ↓
┌────────────────────┐
│  5. 结果输出        │
│  • 技术分析报告     │
│  • AI分析建议       │
│  • 操作建议         │
└────────────────────┘
         │
         ↓
    返回给用户
```

### 2. 智能选股流程

```
启动选股程序
         │
         ↓
┌────────────────────┐
│  1. 获取热门板块    │
│  • Tushare API     │
│  • AKShare API     │
│  • 备用板块列表     │
└────────────────────┘
         │
         ↓
┌────────────────────┐
│  2. 获取成分股      │
│  • 板块成分股列表   │
│  • 排除ST股票       │
│  • 排除科创板       │
└────────────────────┘
         │
         ↓
┌────────────────────┐
│  3. 技术面筛选      │
│  • 评分 ≥ 60       │
│  • 多头排列         │
│  • 乖离率 < 5%     │
└────────────────────┘
         │
         ↓
┌────────────────────┐
│  4. 基本面筛选      │
│  • 市值50-1000亿   │
│  • PE < 100        │
│  • ROE > 15%       │
└────────────────────┘
         │
         ↓
┌────────────────────┐
│  5. 排序输出        │
│  • 按评分排序       │
│  • 生成买入理由     │
│  • 导出Markdown    │
└────────────────────┘
         │
         ↓
    选股报告
```

---

## 模块依赖关系

```
main.py
  ├── src/config.py (配置管理)
  ├── data_provider/ (数据获取)
  │   ├── __init__.py (数据管理器)
  │   ├── tushare_fetcher.py
  │   ├── akshare_fetcher.py
  │   └── efinance_fetcher.py
  ├── src/stock_analyzer.py (技术分析)
  ├── src/search_service.py (新闻搜索)
  └── src/analyzer.py (AI分析)
      ├── GeminiAnalyzer
      ├── ClaudeAnalyzer
      └── OpenAIAnalyzer

select_stocks.py
  ├── src/stock_analyzer.py (技术分析)
  ├── data_provider/ (数据获取)
  └── akshare (板块数据)

bot/
  ├── handler.py (消息处理)
  ├── dispatcher.py (命令分发)
  ├── commands/ (命令处理)
  │   ├── analyze.py
  │   ├── batch.py
  │   └── market.py
  └── platforms/ (平台适配)
      ├── dingtalk.py
      ├── feishu_stream.py
      └── discord.py

web/
  ├── server.py (HTTP服务器)
  ├── handlers.py (请求处理)
  └── static/ (静态资源)
```

---

## 类图

### 数据层类图

```
┌─────────────────────────┐
│     BaseFetcher         │ (抽象基类)
│─────────────────────────│
│ + name: str             │
│ + priority: int         │
│─────────────────────────│
│ + get_daily_data()      │
│ + get_realtime_data()   │
│ + is_available()        │
└─────────────────────────┘
            △
            │ (继承)
    ┌───────┴───────┬───────────┬───────────┐
    │               │           │           │
┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐
│ Tushare   │ │ AKShare   │ │ EFinance  │ │ Baostock  │
│ Fetcher   │ │ Fetcher   │ │ Fetcher   │ │ Fetcher   │
└───────────┘ └───────────┘ └───────────┘ └───────────┘

┌─────────────────────────────────────┐
│     DataFetcherManager              │
│─────────────────────────────────────│
│ - fetchers: List[BaseFetcher]       │
│─────────────────────────────────────│
│ + get_daily_data(code, days)        │
│ + get_realtime_data(code)           │
│ - _try_fetcher(fetcher, ...)        │
└─────────────────────────────────────┘
```

### 分析层类图

```
┌─────────────────────────┐
│  StockTrendAnalyzer     │
│─────────────────────────│
│ + analyze(df, code)     │
│ - _calculate_ma()       │
│ - _calculate_macd()     │
│ - _calculate_kdj()      │
│ - _judge_trend()        │
│ - _calculate_score()    │
└─────────────────────────┘
            │
            │ 返回
            ↓
┌─────────────────────────┐
│ TrendAnalysisResult     │ (数据类)
│─────────────────────────│
│ + signal_score: int     │
│ + buy_signal: BuySignal │
│ + trend_status: Trend   │
│ + ma_status: MAStatus   │
│ + macd_status: MACD     │
│ + kdj_status: KDJ       │
└─────────────────────────┘

┌─────────────────────────┐
│     BaseAnalyzer        │ (抽象基类)
│─────────────────────────│
│ + analyze(context)      │
│ + is_available()        │
└─────────────────────────┘
            △
            │ (继承)
    ┌───────┴───────┬───────────┐
    │               │           │
┌───────────┐ ┌───────────┐ ┌───────────┐
│  Gemini   │ │  Claude   │ │  OpenAI   │
│ Analyzer  │ │ Analyzer  │ │ Analyzer  │
└───────────┘ └───────────┘ └───────────┘
```

---

## 时序图

### 股票分析时序图

```
用户    main.py    DataFetcher    StockAnalyzer    SearchService    AIAnalyzer
 │         │            │               │                │              │
 │ 输入代码 │            │               │                │              │
 ├────────>│            │               │                │              │
 │         │ 获取数据    │               │                │              │
 │         ├───────────>│               │                │              │
 │         │            │ 返回K线数据    │                │              │
 │         │<───────────┤               │                │              │
 │         │            │               │                │              │
 │         │ 技术分析    │               │                │              │
 │         ├───────────────────────────>│                │              │
 │         │            │               │ 返回分析结果    │              │
 │         │<───────────────────────────┤                │              │
 │         │            │               │                │              │
 │         │ 搜索新闻    │               │                │              │
 │         ├───────────────────────────────────────────>│              │
 │         │            │               │                │ 返回新闻     │
 │         │<───────────────────────────────────────────┤              │
 │         │            │               │                │              │
 │         │ AI分析      │               │                │              │
 │         ├───────────────────────────────────────────────────────────>│
 │         │            │               │                │              │ AI处理
 │         │            │               │                │              │
 │         │            │               │                │ 返回AI建议   │
 │         │<───────────────────────────────────────────────────────────┤
 │         │            │               │                │              │
 │ 显示结果 │            │               │                │              │
 │<────────┤            │               │                │              │
 │         │            │               │                │              │
```

---

## 配置管理架构

```
.env (环境变量文件)
  │
  ↓
┌─────────────────────────┐
│    src/config.py        │
│    Config类             │
│─────────────────────────│
│ • 读取.env文件          │
│ • 验证配置              │
│ • 提供配置访问          │
└─────────────────────────┘
  │
  ├─→ AI配置
  │   ├── gemini_api_key
  │   ├── claude_api_key
  │   └── openai_api_key
  │
  ├─→ 数据源配置
  │   ├── tushare_token
  │   └── stock_list
  │
  ├─→ 搜索配置
  │   ├── bocha_api_keys
  │   ├── tavily_api_keys
  │   └── serpapi_keys
  │
  └─→ 机器人配置
      ├── dingtalk_*
      ├── feishu_*
      └── discord_*
```

---

## 错误处理流程

```
API调用
  │
  ↓
┌─────────────────┐
│  尝试调用API     │
└─────────────────┘
  │
  ├─→ 成功 ──→ 返回结果
  │
  └─→ 失败
      │
      ↓
  ┌─────────────────┐
  │  记录错误        │
  │  增加错误计数    │
  └─────────────────┘
      │
      ↓
  ┌─────────────────┐
  │  切换下一个源    │
  └─────────────────┘
      │
      ├─→ 有可用源 ──→ 重试
      │
      └─→ 无可用源
          │
          ↓
      ┌─────────────────┐
      │  使用备用数据    │
      │  或返回错误      │
      └─────────────────┘
```

---

## 缓存策略

```
┌─────────────────────────────────────┐
│          缓存层次                    │
├─────────────────────────────────────┤
│                                     │
│  L1: 内存缓存 (LRU Cache)            │
│  • 股票信息缓存                      │
│  • 板块数据缓存                      │
│  • 有效期: 当日                      │
│                                     │
│  L2: 文件缓存 (可选)                 │
│  • K线数据缓存                       │
│  • 有效期: 1小时                     │
│                                     │
│  L3: 数据库缓存 (未实现)             │
│  • 历史分析结果                      │
│  • 永久存储                          │
│                                     │
└─────────────────────────────────────┘
```

---

## 部署架构

### Docker部署

```
┌─────────────────────────────────────┐
│         Docker Container            │
├─────────────────────────────────────┤
│                                     │
│  ┌─────────────────────────────┐   │
│  │   Python Application        │   │
│  │   • main.py                 │   │
│  │   • web/server.py           │   │
│  │   • bot/platforms/*         │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │   Environment Variables     │   │
│  │   • API Keys                │   │
│  │   • Configuration           │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │   Volumes                   │   │
│  │   • /app/logs               │   │
│  │   • /app/data               │   │
│  └─────────────────────────────┘   │
│                                     │
└─────────────────────────────────────┘
         │
         ↓
    外部访问
    • HTTP: 8080
    • Webhook
```

---

## 性能优化点

```
1. 数据获取优化
   ├── 多源并发请求
   ├── 请求结果缓存
   └── 连接池复用

2. 计算优化
   ├── 向量化计算 (NumPy)
   ├── 并行计算 (多线程)
   └── 增量计算

3. AI调用优化
   ├── Prompt缓存
   ├── 批量请求
   └── 流式响应

4. 存储优化
   ├── 内存缓存 (LRU)
   ├── 文件缓存
   └── 数据压缩
```

---

**说明**: 本文档展示了系统的整体架构和各模块之间的关系，帮助快速理解项目结构。
